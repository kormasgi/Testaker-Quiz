<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Testaker â€“ Study</title>

<link rel="stylesheet" href="style.css">

<style>
.blueBtn{
  background:#2563eb;
  color:white;
}

.blueBtn:hover{
  background:#1d4ed8;
}
</style>
</head>

<body>

<header>ðŸ“š Testaker Study Center</header>

<main>

<!-- MODE SELECT -->
<div id="modeSelect" class="mode-box">

<h2>Choose Mode</h2>

<button type="button" class="blueBtn" onclick="startFlash()">Flashcards</button>
<button type="button" class="blueBtn" onclick="startTest()">Test</button>
<button type="button" class="blueBtn" onclick="startSmart()">Smart Study</button>

</div>


<!-- FLASH -->
<div id="flashMode" class="hidden">

<h2>Flashcards</h2>

<div id="flashCard" class="flash-card" onclick="flip()">
<div class="front"></div>
<div class="back"></div>
</div>

<div id="flashBtns" class="flash-buttons hidden">

<button type="button" class="good" onclick="markFlash(true)">
I Knew This
</button>

<button type="button" class="bad" onclick="markFlash(false)">
I Didnâ€™t Know
</button>

</div>


<div id="flashEnd" class="hidden">

<button type="button" class="blueBtn" onclick="reviewFlash()">
Study Unknown
</button>

<button type="button" class="blueBtn" onclick="startFlash()">
Try Again
</button>

</div>

</div>


<!-- TEST -->
<div id="testMode" class="hidden">

<h2>Test</h2>

<form id="testForm" onsubmit="return false;"></form>

<button
type="button"
id="submitBtn"
class="submit-test blueBtn"
onclick="submitTest()">

Submit

</button>


<div id="testEnd" class="hidden">

<button type="button" class="blueBtn" onclick="reviewTest()">
Study Wrong
</button>

<button type="button" class="blueBtn" onclick="startTest()">
Try Again
</button>

</div>

</div>


<!-- SMART -->
<div id="smartMode" class="hidden">

<h2>Smart Study</h2>

<div id="smartQ" class="smart-box"></div>

<div id="smartAnswer" class="hidden"></div>

<input id="smartInput" class = "test-question" placeholder="Type answer">

<button
type="button"
id="smartBtn"
class="submit-test blueBtn"
onclick="checkSmart()">

Submit

</button>


<button
type="button"
id="smartRetry"
class="blueBtn hidden"
onclick="startSmart()">

Try Again

</button>

</div>

</main>


<script>

/* ================= SOUNDS ================= */

const correctSound = new Audio("sounds/correct.wav");
const wrongSound = new Audio("sounds/wrong.wav");
const streakSound = new Audio("sounds/streak.mp3");

// unlock audio
document.addEventListener("click", ()=>{
  correctSound.play()
  if (currentTime >= .2){
    correctSound.pause();
    correctSound.currentTime=0;
  }
  correctSound.pause();
  correctSound.currentTime=0;
},{once:true});


/* ================= DATA ================= */

const id = new URLSearchParams(location.search).get("id");

let quizzes = JSON.parse(localStorage.getItem("quizzes")||"{}");

let allData = quizzes[id] || [];

let data = [];

let index = 0;

let wrongFlash = [];
let wrongTest = [];

let flashStreak = 0;


/* ================= SAVE ================= */

function save(){
  quizzes[id]=allData;
  localStorage.setItem("quizzes",JSON.stringify(quizzes));
}


/* ================= UTIL ================= */

function hideAll(){

["modeSelect","flashMode","testMode","smartMode"]
.forEach(e=>{
document.getElementById(e).classList.add("hidden");
});

}


function shuffle(arr){

for(let i=arr.length-1;i>0;i--){

const j=Math.floor(Math.random()*(i+1));
[arr[i],arr[j]]=[arr[j],arr[i]];

}

}


/* ================= FLASH ================= */

function startFlash(){

hideAll();

data=[...allData];
wrongFlash=[];
flashStreak=0;

shuffle(data);

index=0;

document.getElementById("flashEnd").classList.add("hidden");

document.getElementById("flashMode").classList.remove("hidden");

showFlash();
}


function showFlash(){

document.getElementById("flashBtns").classList.add("hidden");

document.getElementById("flashCard").classList.remove("flipped");

document.querySelector(".front").textContent=data[index].q;
document.querySelector(".back").textContent=data[index].a;
}


function flip(){

document.getElementById("flashCard").classList.add("flipped");
document.getElementById("flashBtns").classList.remove("hidden");
}


function markFlash(ok){

if(ok){

correctSound.play();
flashStreak++;
data[index].score++;

}

else{

wrongSound.play();

if(flashStreak>0) streakSound.play();

flashStreak=0;

data[index].score-=2;

wrongFlash.push(data[index]);

}

save();

index++;

if(index>=data.length){

endFlash();
return;

}

showFlash();
}


function endFlash(){

document.getElementById("flashBtns").classList.add("hidden");
document.getElementById("flashEnd").classList.remove("hidden");
}


function reviewFlash(){

if(!wrongFlash.length) return;

hideAll();

data=[...wrongFlash];
wrongFlash=[];

shuffle(data);

index=0;

document.getElementById("flashEnd").classList.add("hidden");

document.getElementById("flashMode").classList.remove("hidden");

showFlash();
}


/* ================= TEST ================= */

function startTest(){

hideAll();

data=[...allData];
wrongTest=[];

document.getElementById("submitBtn").disabled=false;

document.getElementById("testEnd").classList.add("hidden");

document.getElementById("testMode").classList.remove("hidden");

buildTest();
}


function buildTest(){

const form=document.getElementById("testForm");

form.innerHTML="";

data.forEach((item,i)=>{

const div=document.createElement("div");

div.className="test-question";

div.innerHTML=`

<div>${i+1}. ${item.q}</div>

<input data-i="${i}">

`;

form.appendChild(div);

});

}


function submitTest(){

wrongTest=[];

const inputs=document.querySelectorAll("#testForm input");

inputs.forEach(input=>{

const i=input.dataset.i;

const user=input.value.trim().toLowerCase();
const real=data[i].a.toLowerCase();

if(user===real && user!==""){

data[i].score++;
input.style.borderColor="green";

}

else{

data[i].score-=2;
wrongTest.push(data[i]);
input.style.borderColor="red";

}

});

save();

document.getElementById("submitBtn").disabled=true;

document.getElementById("testEnd").classList.remove("hidden");
}


function reviewTest(){

if(!wrongTest.length) return;

hideAll();

data=[...wrongTest];
wrongTest=[];

document.getElementById("testMode").classList.remove("hidden");

buildTest();
}


/* ================= SMART ================= */

let smartQueue = [];
let smartIndex = 0;

let redo = false;
let current = null;


/* Start Smart */

function startSmart(){

  hideAll();

  redo = false;
  smartIndex = 0;
  current = null;

  document.getElementById("smartRetry").classList.add("hidden");

  document.getElementById("smartInput").style.display = "block";
  document.getElementById("smartBtn").style.display = "block";

  document.getElementById("smartInput").value = "";

  document.getElementById("smartAnswer").classList.add("hidden");

  document.getElementById("smartMode").classList.remove("hidden");


  // Make sure every question has a score
  allData.forEach(q=>{
    if(typeof q.score !== "number"){
      q.score = 0;
    }
  });

  save();

  buildSmartQueue();
  nextSmart();
}


/* Build weighted queue */

function buildSmartQueue(){

  smartQueue = [];


  allData.forEach(q=>{

    if(q.score < 5){

      // Lower score = more copies
      let weight = Math.max(1, 6 - q.score);

      // Prevent insane spam
      weight = Math.min(weight, 10);

      for(let i=0;i<weight;i++){
        smartQueue.push(q);
      }

    }

  });

  shuffle(smartQueue);
}


/* Next Question */

function nextSmart(){

  redo = false;

  document.getElementById("smartAnswer").classList.add("hidden");


  // Finished
  if(smartQueue.length === 0){

    document.getElementById("smartQ").textContent =
      "ðŸŽ‰ Smart Study Complete!";

    document.getElementById("smartInput").style.display = "none";
    document.getElementById("smartBtn").style.display = "none";

    document.getElementById("smartRetry").classList.remove("hidden");

    return;
  }


  // Get next unique question
  current = smartQueue.shift();


  document.getElementById("smartQ").textContent = current.q;

  document.getElementById("smartInput").value = "";
}


/* Check Answer */

function checkSmart(){

  const input =
    document.getElementById("smartInput")
    .value.trim().toLowerCase();

  if(!input) return;


  const real = current.a.toLowerCase();


  /* Normal attempt */

  if(!redo){

    // Correct
    if(input === real){

      correctSound.play();

      current.score += 1;

      save();

      nextSmart();

    }

    // Wrong
    else{

      wrongSound.play();

      current.score -= 2;

      save();

      redo = true;


      document.getElementById("smartAnswer")
        .textContent = "Correct: " + current.a;

      document.getElementById("smartAnswer")
        .classList.remove("hidden");

    }

  }


  /* Redo attempt (no points) */

  else{

    if(input === real){

      correctSound.play();

      redo = false;

      nextSmart();

    }

  }

}

</script>
</body>
</html>