<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Testaker â€“ Study</title>

<link rel="stylesheet" href="style.css">

<style>
.blueBtn{
  background:#2563eb;
  color:white;
}
.blueBtn:hover{
  background:#1d4ed8;
}
</style>
</head>

<body>

<header>ðŸ“š Testaker Study Center</header>

<main>

<!-- MODE SELECT -->
<div id="modeSelect" class="mode-box">

<h2>Choose Mode</h2>

<button class="blueBtn" onclick="startFlash()">Flashcards</button>
<button class="blueBtn" onclick="startTest()">Test</button>
<button class="blueBtn" onclick="startSmart()">Smart Study</button>

</div>


<!-- FLASH -->
<div id="flashMode" class="hidden">

<h2>Flashcards</h2>

<div id="flashCard" class="flash-card" onclick="flip()">
<div class="front"></div>
<div class="back"></div>
</div>

<div id="flashBtns" class="flash-buttons hidden">

<button class="good" onclick="markFlash(true)">I Knew This</button>
<button class="bad" onclick="markFlash(false)">I Didnâ€™t Know</button>

</div>

<div id="flashEnd" class="hidden">

<button class="blueBtn" onclick="reviewFlash()">Study Unknown</button>
<button class="blueBtn" onclick="startFlash()">Try Again</button>

</div>

</div>


<!-- TEST -->
<div id="testMode" class="hidden">

<h2>Test</h2>

<form id="testForm"></form>

<button id="submitBtn" class="submit-test blueBtn" onclick="submitTest()">
Submit
</button>

<div id="testEnd" class="hidden">

<button class="blueBtn" onclick="reviewTest()">Study Wrong</button>
<button class="blueBtn" onclick="startTest()">Try Again</button>

</div>

</div>


<!-- SMART -->
<div id="smartMode" class="hidden">

<h2>Smart Study</h2>

<div class="progress-wrap">
  <div id="smartProgress"></div>
</div>

<div id="smartQ" class="smart-box"></div>

<div id="smartAnswer" class="hidden"></div>

<input id="smartInput" class="test-question" placeholder="Type answer">

<button id="smartBtn" class="submit-test blueBtn" onclick="checkSmart()">
Submit
</button>

<button id="smartRetry" class="blueBtn hidden" onclick="startSmart()">
Try Again
</button>


<!-- WEAK SUMMARY -->
<div id="weakBox" class="hidden">

<h3>ðŸ“‰ Weak Points</h3>

<div id="weakList"></div>

<button class="blueBtn" onclick="studyWeakFlash()">
Study Weakpoints (Flashcards)
</button>

<button class="blueBtn" onclick="studyWeakSmart()">
Study Weakpoints (Smart Study)
</button>

</div>

</div>

</main>


<script>

/* ============ SOUNDS ============ */

const correctSound=new Audio("sounds/correct.wav");
const wrongSound=new Audio("sounds/wrong.wav");
const streakSound=new Audio("sounds/streak.mp3");

document.addEventListener("click",()=>{
  correctSound.play();
  correctSound.pause();
  correctSound.currentTime=0;
},{once:true});


/* ============ DATA ============ */

const id=new URLSearchParams(location.search).get("id");

let quizzes=JSON.parse(localStorage.getItem("quizzes")||"{}");
let allData=quizzes[id]||[];

let data=[];
let index=0;

let wrongFlash=[];
let wrongTest=[];

let flashStreak=0;


/* INIT EXTRA DATA */

allData.forEach(q=>{
  if(typeof q.score!=="number") q.score=0;
  if(typeof q.seen!=="number") q.seen=0;
});


/* ============ SAVE ============ */

function save(){
  quizzes[id]=allData;
  localStorage.setItem("quizzes",JSON.stringify(quizzes));
}


/* ============ UTIL ============ */

function hideAll(){

["modeSelect","flashMode","testMode","smartMode"]
.forEach(id=>{
document.getElementById(id).classList.add("hidden");
});

}


function shuffle(arr){
for(let i=arr.length-1;i>0;i--){
const j=Math.floor(Math.random()*(i+1));
[arr[i],arr[j]]=[arr[j],arr[i]];
}
}


/* ============ FLASH ============ */

function startFlash(){

hideAll();

data=[...allData];
wrongFlash=[];
flashStreak=0;

shuffle(data);

index=0;

document.getElementById("flashEnd").classList.add("hidden");

document.getElementById("flashMode").classList.remove("hidden");

showFlash();
}


function showFlash(){

document.getElementById("flashBtns").classList.add("hidden");

document.getElementById("flashCard").classList.remove("flipped");

document.querySelector(".front").textContent=data[index].q;
document.querySelector(".back").textContent=data[index].a;
}


function flip(){
document.getElementById("flashCard").classList.add("flipped");
document.getElementById("flashBtns").classList.remove("hidden");
}


function markFlash(ok){

if(ok){

correctSound.play();
flashStreak++;
data[index].score++;

}else{

wrongSound.play();

if(flashStreak>0) streakSound.play();

flashStreak=0;

data[index].score-=2;

wrongFlash.push(data[index]);
}

save();

index++;

if(index>=data.length){
endFlash();
return;
}

showFlash();
}


function endFlash(){
document.getElementById("flashBtns").classList.add("hidden");
document.getElementById("flashEnd").classList.remove("hidden");
}


function reviewFlash(){

if(!wrongFlash.length) return;

hideAll();

data=[...wrongFlash];
wrongFlash=[];

shuffle(data);

index=0;

document.getElementById("flashEnd").classList.add("hidden");

document.getElementById("flashMode").classList.remove("hidden");

showFlash();
}


/* ============ TEST ============ */

function startTest(){

hideAll();

data=[...allData];
wrongTest=[];

document.getElementById("submitBtn").disabled=false;
document.getElementById("testEnd").classList.add("hidden");

document.getElementById("testMode").classList.remove("hidden");

buildTest();
}


function buildTest(){

const form=document.getElementById("testForm");

form.innerHTML="";

data.forEach((item,i)=>{

const div=document.createElement("div");

div.className="test-question";

div.innerHTML=`
<div>${i+1}. ${item.q}</div>
<input data-i="${i}">
`;

form.appendChild(div);

});

}


function submitTest(){

wrongTest=[];

const inputs=document.querySelectorAll("#testForm input");

inputs.forEach(input=>{

const i=input.dataset.i;

const user=input.value.trim().toLowerCase();
const real=data[i].a.toLowerCase();

if(user===real && user!==""){

data[i].score++;
input.style.borderColor="green";

}else{

data[i].score-=2;
wrongTest.push(data[i]);
input.style.borderColor="red";
}

});

save();

document.getElementById("submitBtn").disabled=true;
document.getElementById("testEnd").classList.remove("hidden");
}


function reviewTest(){

if(!wrongTest.length) return;

hideAll();

data=[...wrongTest];
wrongTest=[];

document.getElementById("testMode").classList.remove("hidden");

buildTest();
}


/* ============ SMART STUDY ============ */

let smartPool=[];
let last=null;
let redo=false;
let current=null;


function startSmart(){

  hideAll();

  redo = false;
  current = null;
  last = null;

  // Hide weak summary
  document.getElementById("weakBox").classList.add("hidden");

  // Re-enable UI
  document.getElementById("smartInput").style.display = "block";
  document.getElementById("smartBtn").style.display = "block";

  document.getElementById("smartRetry").classList.add("hidden");

  document.getElementById("smartAnswer").classList.add("hidden");

  document.getElementById("smartInput").value = "";

  document.getElementById("smartMode").classList.remove("hidden");


  // Reset mastered questions ONLY if all done
  if(allData.every(q => q.score >= 5)){

    allData.forEach(q=>{
      q.score = 0;
      q.seen = 0;
    });

    save();
  }


  // Rebuild pool
  buildSmartPool();

  updateProgress();

  nextSmart();
}


function buildSmartPool(){

smartPool=[];

allData.forEach(q=>{

if(q.score<5){

let w=Math.max(1,6-q.score);

for(let i=0;i<w;i++){
smartPool.push(q);
}

}

});

shuffle(smartPool);
}


function nextSmart(){

redo=false;

document.getElementById("smartAnswer").classList.add("hidden");


if(!smartPool.length){

endSmart();
return;
}


let next;

do{
next=smartPool[Math.floor(Math.random()*smartPool.length)];
}
while(next===last && smartPool.length>1);

current=next;
last=next;

current.seen++;

save();

document.getElementById("smartQ").textContent=current.q;
document.getElementById("smartInput").value="";
}


function checkSmart(){

const val=document.getElementById("smartInput")
.value.trim().toLowerCase();

if(!val) return;

const real=current.a.toLowerCase();


if(!redo){

if(val===real){

correctSound.play();

current.score++;

if(current.score>=5){
smartPool=smartPool.filter(q=>q!==current);
}

save();
updateProgress();

nextSmart();

}else{

wrongSound.play();

current.score-=2;

save();
updateProgress();

redo=true;

document.getElementById("smartAnswer")
.textContent="Correct: "+current.a;

document.getElementById("smartAnswer")
.classList.remove("hidden");

}

}else{

if(val===real){

correctSound.play();

redo=false;
nextSmart();
}

}

}


/* ============ PROGRESS ============ */

function updateProgress(){

let total=allData.length*5;

let cur=0;

allData.forEach(q=>{
cur+=Math.min(5,q.score);
});

let percent=(cur/total)*100;

percent=Math.max(0,Math.min(100,percent));

const bar=document.getElementById("smartProgress");

bar.style.width=percent+"%";

let r=Math.floor(255-(percent*2.55));
let g=Math.floor(percent*2.55);

bar.style.background=`rgb(${r},${g},80)`;
}


/* ============ WEAK POINTS ============ */

let weakData=[];


function endSmart(){

document.getElementById("smartQ").textContent=
"ðŸŽ‰ Smart Study Complete!";

document.getElementById("smartInput").style.display="none";
document.getElementById("smartBtn").style.display="none";

document.getElementById("smartRetry").classList.remove("hidden");

buildWeak();

document.getElementById("weakBox").classList.remove("hidden");
}


function buildWeak(){

weakData=[...allData];

weakData.sort((a,b)=>a.score-b.score);

const count=Math.max(1,Math.ceil(weakData.length*0.15));

weakData=weakData.slice(0,count);

const list=document.getElementById("weakList");

list.innerHTML="";

weakData.forEach(q=>{

const div=document.createElement("div");

div.textContent=
`â€¢ ${q.q} (Seen ${q.seen}Ã—, Score ${q.score})`;

list.appendChild(div);

});

}


/* STUDY WEAK */

function studyWeakFlash(){

if(!weakData.length) return;

hideAll();

data=[...weakData];
wrongFlash=[];
flashStreak=0;

shuffle(data);

index=0;

document.getElementById("flashMode").classList.remove("hidden");

showFlash();
}


function studyWeakSmart(){

if(!weakData.length) return;

hideAll();

smartPool=[...weakData];

shuffle(smartPool);

last=null;

document.getElementById("smartMode").classList.remove("hidden");

nextSmart();
}

</script>

</body>
</html>